<!-- callback.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Spotify OAuth Callback</title>
</head>
<body>
  <pre id="output">Waiting for code…</pre>
  <script type="module">
    (async () => {
      const out    = document.getElementById('output');
      const params = new URLSearchParams(window.location.search);
      const code   = params.get('code');
      const state  = params.get('state');

      if (!code) {
        out.textContent = `No code in URL: ${window.location.search}`;
        return;
      }

      out.textContent = 'Exchanging code for token…';
      try {
        const res = await fetch('http://127.0.0.1:3001/exchange_token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        // store under spotify_token_user1 or spotify_token_user2
        localStorage.setItem(`spotify_token_${state}`, data.access_token);

        // go back home
        window.location.href = 'index.html';

      } catch (e) {
        out.textContent = 'Exchange failed: ' + e.message;
      }
    })();
  </script>
</body>
</html>
